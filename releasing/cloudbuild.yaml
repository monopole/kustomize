steps:
- name: 'bash'
  args:
  - 'echo'
  - 'Cloud build substitution check: '
  - 'BUILD_ID=$BUILD_ID'
  - 'PROJECT_ID=$PROJECT_ID'
  - 'REVISION_ID=$REVISION_ID'
  - 'REPO_NAME=$REPO_NAME'
  - 'COMMIT_SHA=$COMMIT_SHA'
  - 'BRANCH_NAME=$BRANCH_NAME'
  - 'TAG_NAME=$TAG_NAME'

# Cloud build has already copied the repo at a particular tag,
# but hasn't actually cloned it; there's no .git directory.
# goreleaser, however, needs the repo and its history to produce
# release notes. Hence the need for git, hence the need for a new workspace?

- name: "gcr.io/cloud-builders/git"
  args: [fetch, --tags, --depth=100]

#- name: 'gcr.io/cloud-builders/git'
#  args: ['clone', 'https://github.com/GoogleCloudPlatform/cloud-builders']

- name: 'goreleaser/goreleaser:v0.138.0'
  entrypoint: /bin/sh
  # The final arg here should be '--snapshot' on a local build,
  # to suppress the release and leave the 'dist' directory in place.
  args: ['releasing/cloudbuild.sh', '$TAG_NAME']
  secretEnv: ['GITHUB_TOKEN']

# golreleaser expects the GITHUB_TOKEN env var to hold the github token
# it needs to write the released package and notes back to github.
# The raw token was encrypted by gcloud kms (Key Management Service)
# The base64 of that is shown below.  It get decrypted by cloud build
# and provided back to goreleaser.

secrets:
- kmsKeyName: projects/lyrical-gantry-618/locations/global/keyRings/kust-cloud-key-ring/cryptoKeys/kust-cloud-key-name
  secretEnv:
    GITHUB_TOKEN: CiQA2iACN7mMsSYG+jqxUiZyZc5OKJy4iybEVCPZS+bFAYOjyaESUQCRivMAyxoowmb9mWId8BD9XHG2K9he1UAFBgQXNnTIOMZChZZEhXzVDyB7fOOSDYuaHxB5TnNm97euwjVUFxP977jWqXoct6m3ocAf5VBEAQ==

# secrets:
# - kmsKeyName: projects/jregan-corp-gke-dev/locations/global/keyRings/kust-cloud-key-ring/cryptoKeys/kust-cloud-key-name
#   secretEnv:
#     GITHUB_TOKEN: CiQAwfbOkSP4tJf3ZJZMjzHaRPZ2RxiQhORZ3xxlVtpoy8631uQSUACk6WMKjtkpsRkRl+uxWUVvN29M5qveyXjaDDO094/qwsSc8RiYlHYt7Ii1bWkkz3P1kG0nHfG7Fd46A+GJ6R5NhmNfingd/nu9iKrNwLXK
#
#

# secrets:
# - kmsKeyName: projects/lyrical-gantry-618/locations/global/keyRings/kust-cloud-key-ring/cryptoKeys/kust-cloud-key-name
#   secretEnv:
#     GITHUB_TOKEN: CiQA2iACN7mMsSYG+jqxUiZyZc5OKJy4iybEVCPZS+bFAYOjyaESUQCRivMAyxoowmb9mWId8BD9XHG2K9he1UAFBgQXNnTIOMZChZZEhXzVDyB7fOOSDYuaHxB5TnNm97euwjVUFxP977jWqXoct6m3ocAf5VBEAQ==



# - name: 'gcr.io/cloud-builders/docker'

#- name: 'ubuntu'
#  args: ['bash', 'releasing/echo.sh']
